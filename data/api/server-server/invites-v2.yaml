# Copyright 2018-2019 New Vector Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
openapi: 3.1.0
info:
  title: Matrix Federation Invite User To Room API
  version: 1.0.0
paths:
  "/invite/{roomId}/{eventId}":
    put:
      summary: Invites a remote user to a room
      description: |-
        **Note:**
        This API is nearly identical to the v1 API with the exception of the request
        body being different, and the response format fixed.

        Invites a remote user to a room. Once the event has been signed by both the inviting
        homeserver and the invited homeserver, it can be sent to all of the servers in the
        room by the inviting homeserver.

        This endpoint is preferred over the v1 API as it is more useful for servers. Senders
        which receive a 400 or 404 response to this endpoint should retry using the v1
        API as the server may be older, if the room version is "1" or "2".

        Note that events have a different format depending on the room version - check the
        [room version specification](/rooms) for precise event formats. **The request and response
        bodies here describe the common event fields in more detail and may be missing other
        required fields for a PDU.**

        Also note that if the remote homeserver is already in the room, it will receive the
        invite event twice; once through this endpoint, and again through a [federation
        transaction](/server-server-api/#transactions).

        Servers MUST apply certain validation to ensure they don't accidentally sign non-invite
        events from a malicious server. The `M_MISSING_PARAM` error code is used to indicate one
        or more of the following:

        * The invite event fails a [signature check](/server-server-api/#validating-hashes-and-signatures-on-received-events).
        * The event type is not `m.room.member`.
        * The `membership` field inside the event content is not `invite`.
        * The event sender is not a user ID on the origin server.
        * The `state_key` is not a user ID on the receiving server.

        The `M_MISSING_PARAM` error code is also used to indicate one or more of the following
        problems in the `invite_room_state` field:

        * The `m.room.create` event is missing from `invite_room_state`.
        * One or more entries in `invite_room_state` are not formatted according
          to the room's version.
        * One or more events fails a [signature check](/server-server-api/#validating-hashes-and-signatures-on-received-events).
        * One or more events does not reside in the same room as the invite.
          Note: Some room versions may require calculating the room ID for an
          event rather than relying on the presence of `room_id`.

        Servers MAY apply the `invite_room_state` validation to room versions 1 through 11,
        and SHOULD apply the validation to all other room versions.
      operationId: sendInviteV2
      security:
        - signedRequest: []
      parameters:
        - in: path
          name: roomId
          description: The room ID that the user is being invited to.
          required: true
          example: "!abc123:matrix.org"
          schema:
            type: string
        - in: path
          name: eventId
          description: The event ID for the invite event, generated by the inviting server.
          required: true
          example: $abc123:example.org
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                room_version:
                  type: string
                  description: The version of the room where the user is being invited to.
                  example: "2"
                event:
                  $ref: definitions/invite_event.yaml
                invite_room_state:
                  type: array
                  x-changedInMatrixVersion:
                    "1.16": |
                      `m.room.create` and format requirements were added.
                  description: |-
                    A list of state events to help the receiver of the invite identify the room.
                    Translated as [stripped state events](/client-server-api/#stripped-state)
                    over the Client-Server API.

                    MUST contain the `m.room.create` event for the room. All events listed
                    MUST additionally be formatted according to the room version specification.

                    Servers might need to apply validation to the `invite_room_state` depending
                    on room version. See the `400 M_MISSING_PARAM` error definition for more
                    information.

                    Note that events have a different format depending on the room
                    version - check the [room version specification](/rooms) for
                    precise event formats.
                  items:
                    type: object
                    title: PDU
                    properties: {}
                    description: |-
                      Note that events have a different format depending on the room
                      version - check the [room version specification](/rooms) for
                      precise event formats.
              required:
                - room_version
                - event
        required: true
      responses:
        "200":
          description: |-
            The event with the invited server's signature added. All other fields of the events
            should remain untouched. Note that events have a different format depending on the
            room version - check the [room version specification](/rooms) for precise event formats.
          content:
            application/json:
              schema:
                type: object
                description: An object containing the signed invite event.
                title: Event Container
                properties:
                  event:
                    $ref: definitions/invite_event.yaml
                required:
                  - event
              examples:
                response:
                  value: {
                    "event": {
                      "room_id": "!somewhere:example.org",
                      "type": "m.room.member",
                      "state_key": "@someone:example.org",
                      "origin": "example.org",
                      "origin_server_ts": 1549041175876,
                      "sender": "@someone:example.org",
                      "unsigned": {
                        "invite_room_state": {"$ref": "./examples/invite_or_knock_state.json"}
                      },
                      "content": {
                        "membership": "invite"
                      },
                      "signatures": {
                        "example.com": {
                          "ed25519:key_version": "SomeSignatureHere"
                        },
                        "elsewhere.com": {
                          "ed25519:k3y_versi0n": "SomeOtherSignatureHere"
                        }
                      }
                    }
                  }
        "400":
          description: |-
            The request is invalid or the room the server is attempting
            to join has a version that is not listed in the `ver`
            parameters.

            The error should be passed through to clients so that they
            may give better feedback to users.

            If `M_MISSING_PARAM` is returned and the request is associated with a
            Client-Server API request, the Client-Server API request SHOULD fail
            with a 5xx error rather than being passed through.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: ../client-server/definitions/errors/error.yaml
                  - type: object
                    properties:
                      room_version:
                        type: string
                        description: |-
                          The version of the room. Required if the `errcode`
                          is `M_INCOMPATIBLE_ROOM_VERSION`.
              examples:
                response:
                  value: {
                    "errcode": "M_INCOMPATIBLE_ROOM_VERSION",
                    "error": "Your homeserver does not support the features required to join this room",
                    "room_version": "3"
                  }
        "403":
          description: |-
            The invite is not allowed.

            The `M_FORBIDDEN` error code is used to indicate one of the following:

            * The sender is not allowed to send invites to the target user/homeserver.
            * The homeserver does not permit anyone to invite its users.
            * The homeserver refuses to participate in the room.

            {{% added-in v="1.18"%}} The `M_INVITE_BLOCKED` error code is used to
            indicate that the homeserver rejected the invite due to
            [invite blocking](/client-server-api/#invite-permission).
          content:
            application/json:
              schema:
                $ref: ../client-server/definitions/errors/error.yaml
              examples:
                response:
                  value: {
                    "errcode": "M_FORBIDDEN",
                    "error": "User cannot invite the target user."
                  }
servers:
  - url: "{protocol}://{hostname}{basePath}"
    variables:
      protocol:
        enum:
          - http
          - https
        default: https
      hostname:
        default: localhost:8448
      basePath:
        default: /_matrix/federation/v2
components:
  securitySchemes:
    signedRequest:
      $ref: definitions/security.yaml#/signedRequest
